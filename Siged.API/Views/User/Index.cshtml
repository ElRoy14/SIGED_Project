@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Users</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <style>
        /* Custom styles */
        .table thead th {
            background-color: #343a40;
            color: #fff;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .btn-custom {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between mb-4">
            <h3>All Users</h3>
            <button class="btn btn-primary btn-custom" id="btn-register">Register</button>
        </div>
        <div id="userList" class="table-responsive"></div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            var token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/home/login'; // Redirigir al inicio de sesión si no hay token
                return;
            }

            // Controlador de evento para el botón de Registro
            $('#btn-register').click(function () {
                // Redirigir al formulario de registro
                window.location.href = '/user/register';
            });

            // Controlador de evento para el botón de Editar
            $(document).on('click', '.btn-edit', function () {
                var userId = $(this).data('userid');
                var fullName = $('#fullName_' + userId).text();
                var email = $('#email_' + userId).text();
                var rolDescription = $('#rolDescription_' + userId).text();
                var departmentDescription = $('#departmentDescription_' + userId).text();

                // Mostrar campos de edición
                $('#fullName_' + userId).html('<input type="text" id="edit_fullName_' + userId + '" value="' + fullName + '" />');
                $('#email_' + userId).html('<input type="email" id="edit_email_' + userId + '" value="' + email + '" />');
                $('#rolDescription_' + userId).html('<input type="text" id="edit_rolDescription_' + userId + '" value="' + rolDescription + '" />');
                $('#departmentDescription_' + userId).html('<input type="text" id="edit_departmentDescription_' + userId + '" value="' + departmentDescription + '" />');

                // Mostrar botón de Guardar
                $(this).hide();
                $('#btn-save_' + userId).show();
            });

            // Controlador de evento para el botón de Guardar
            $(document).on('click', '.btn-save', function () {
                var userId = $(this).data('userid');
                var fullName = $('#edit_fullName_' + userId).val();
                var email = $('#edit_email_' + userId).val();
                var rolDescription = $('#edit_rolDescription_' + userId).val();
                var departmentDescription = $('#edit_departmentDescription_' + userId).val();

                var userData = {
                    userId: userId,
                    fullName: fullName,
                    email: email,
                    rolDescription: rolDescription,
                    departmentDescription: departmentDescription
                };

                // Realizar solicitud de actualización al servidor
                $.ajax({
                    url: '/api/User/UpdateUser',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(userData),
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (response) {
                        if (response.status) {
                            // Actualizar la vista después de la edición
                            loadUsers();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            });

            // Controlador de evento para el botón de Eliminar
            $(document).on('click', '.btn-delete', function () {
                var userId = $(this).data('userid');

                // Realizar solicitud de eliminación al servidor
                $.ajax({
                    url: '/api/User/DeleteUser/' + userId,
                    type: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (response) {
                        if (response.status) {
                            // Actualizar la vista después de la eliminación
                            loadUsers();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            });

            // Función para cargar la lista de usuarios
            function loadUsers() {
                $.ajax({
                    url: '/api/User/GetAllUsers',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (response) {
                        if (response.status) {
                            var users = response.value;
                            var userListHtml = '<table class="table table-bordered table-hover"><thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Departamento</th><th>Identification Card</th><th>Phone Number</th><th>Password</th><th>Role ID</th><th>Active State</th><th>Acciones</th></tr></thead><tbody>';
                            users.forEach(function (user) {
                                userListHtml += '<tr>' +
                                    '<td>' + user.userId + '</td>' +
                                    '<td id="fullName_' + user.userId + '">' + user.fullName + '</td>' +
                                    '<td id="email_' + user.userId + '">' + user.email + '</td>' +
                                    '<td id="rolDescription_' + user.userId + '">' + user.rolDescription + '</td>' +
                                    '<td id="departmentDescription_' + user.userId + '">' + user.departmentDescription + '</td>' +
                                    '<td id="identificationCard_' + user.userId + '">' + user.identificationCard + '</td>' +
                                    '<td id="phoneNumber_' + user.userId + '">' + user.phoneNumber + '</td>' +
                                    '<td id="password_' + user.userId + '">' + user.password + '</td>' +
                                    '<td id="roleId_' + user.userId + '">' + user.roleId + '</td>' +
                                    '<td id="activeState_' + user.userId + '">' + user.activeState + '</td>' +
                                    '<td>' +
                                    '<button class="btn btn-sm btn-warning btn-custom btn-edit" data-userid="' + user.userId + '">Editar</button>' +

                                    '<button class="btn btn-sm btn-danger btn-custom btn-delete" data-userid="' + user.userId + '">Eliminar</button>' +
                                    '<button class="btn btn-sm btn-success btn-save" id="btn-save_' + user.userId + '" data-userid="' + user.userId + '" style="display:none;">Guardar</button>' +
                                    '</td>' +
                                    '</tr>';
                            });
                            userListHtml += '</tbody></table>';
                            $('#userList').html(userListHtml);
                        } else {
                            $('#userList').html('<div class="alert alert-danger">' + response.message + '</div>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            }

            // Cargar la lista de usuarios al cargar la página
            loadUsers();
        });
    </script>
</body>
</html>
