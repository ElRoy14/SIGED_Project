@{
    ViewData["Title"] = "Lista de Usuarios";
    Layout = "~/Views/Shared/_Layout.cshtml"; // Ajusta la ruta según tu estructura de proyecto
}

<div class="container">
    <h1>Listado de Usuarios</h1>

    <!-- Botón Registrar Usuario -->
    <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#addUserModal">Registrar Usuario</button>

    <div id="userList">
        <!-- Aquí se cargará dinámicamente la tabla de usuarios -->
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cedula</th>
                    <th>Nombre</th>
                    <th>Telefono</th>
                    <th>Correo</th>
                    <th>Rol</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se insertarán dinámicamente las filas de usuarios -->
            </tbody>
        </table>
    </div>

    <!-- Modal Agregar Usuario -->
    <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <!-- Cambiado a modal-lg para mayor ancho -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Registrar Nuevo Usuario</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Formulario para agregar usuario -->
                    <form id="addUserForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="fullName">Nombre Completo</label>
                                <input type="text" class="form-control" id="fullName" name="fullName" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="identificationCard">Cedula</label>
                                <input type="text" class="form-control" id="identificationCard" name="identificationCard" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="phoneNumber">Telefono</label>
                                <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="email">Correo</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="userPassword">Contraseña</label>
                                <input type="password" class="form-control" id="userPassword" name="userPassword" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="rolId">Rol</label>
                                <select class="form-control" id="rolId" name="rolId" required>
                                    <option value="">Seleccione un Rol</option>
                                    @foreach (var rol in ViewBag.Roles)
                                    {
                                        <option value="@rol.RolId">@rol.NameRol</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="jobTitleId">Cargo</label>
                                <select class="form-control" id="jobTitleId" name="jobTitleId" required>
                                    <option value="">Seleccione un Cargo</option>
                                    @foreach (var jobTitle in ViewBag.JobTitles)
                                    {
                                        <option value="@jobTitle.JobTitleId">@jobTitle.JobTitleName</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="departmentId">Departamento</label>
                                <select class="form-control" id="departmentId" name="departmentId" required>
                                    <option value="">Seleccione un Departamento</option>
                                    @foreach (var department in ViewBag.Departments)
                                    {
                                        <option value="@department.DepartmentId">@department.DepartmentName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="isActive">Estado</label>
                                <select class="form-control" id="isActive" name="isActive" required>
                                    <option value="1">Activo</option>
                                    <option value="0">No Activo</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnSaveUser">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Editar Usuario</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Formulario para editar usuario -->
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" name="userId">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editFullName">Nombre Completo</label>
                                <input type="text" class="form-control" id="editFullName" name="fullName" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editIdentificationCard">Cedula</label>
                                <input type="text" class="form-control" id="editIdentificationCard" name="identificationCard" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editPhoneNumber">Telefono</label>
                                <input type="text" class="form-control" id="editPhoneNumber" name="phoneNumber" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editEmail">Correo</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editUserPassword">Contraseña</label>
                                <input type="password" class="form-control" id="editUserPassword" name="userPassword" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editRolId">Rol</label>
                                <select class="form-control" id="editRolId" name="rolId" required>
                                    <option value="">Seleccione un Rol</option>
                                    @foreach (var rol in ViewBag.Roles)
                                    {
                                        <option value="@rol.RolId">@rol.NameRol</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editJobTitleId">Cargo</label>
                                <select class="form-control" id="editJobTitleId" name="jobTitleId" required>
                                    <option value="">Seleccione un Cargo</option>
                                    @foreach (var jobTitle in ViewBag.JobTitles)
                                    {
                                        <option value="@jobTitle.JobTitleId">@jobTitle.JobTitleName</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="editDepartmentId">Departamento</label>
                                <select class="form-control" id="editDepartmentId" name="departmentId" required>
                                    <option value="">Seleccione un Departamento</option>
                                    @foreach (var department in ViewBag.Departments)
                                    {
                                        <option value="@department.DepartmentId">@department.DepartmentName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="editIsActive">Estado</label>
                                <select class="form-control" id="editIsActive" name="isActive" required>
                                    <option value="1">Activo</option>
                                    <option value="0">No Activo</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnUpdateUser">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        // Función para cargar usuarios mediante AJAX
        function loadUsers() {
            $.ajax({
                url: '/User/GetUsers',
                type: 'GET',
                success: function (response) {
                    console.log(response); // Log the response to check for errors
                    if (response.status) {
                        var users = response.value;
                        var userListHtml = '';
                        users.forEach(function (user) {
                            var isActiveText = user.isActive === 1 ? 'Activo' : 'No Activo';
                            userListHtml += '<tr>' +
                                '<td>' + user.userId + '</td>' +
                                '<td>' + user.identificationCard + '</td>' +
                                '<td>' + user.fullName + '</td>' +
                                '<td>' + user.phoneNumber + '</td>' +
                                '<td>' + user.email + '</td>' +
                                '<td>' + user.rolDescription + '</td>' +
                                '<td>' + user.jobTitleDescription + '</td>' +
                                '<td>' + user.departmentDescription + '</td>' +
                                '<td>' + isActiveText + '</td>' +
                                '<td>' +
                                '<button class="btn btn-sm btn-warning btn-custom btn-edit" data-userid="' + user.userId + '">Editar</button>' +
                                '<button class="btn btn-sm btn-danger btn-custom btn-delete" data-userid="' + user.userId + '">Eliminar</button>' +
                                '</td>' +
                                '</tr>';
                        });
                        $('#userList tbody').html(userListHtml); // Inserta las filas de usuarios en la tabla
                    } else {
                        $('#userList').html('<div class="alert alert-danger">' + response.message + '</div>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }

        // Función para obtener datos de usuario por ID
        function getUserById(userId) {
            $.ajax({
                url: '/User/GetUserById?id=' + userId,
                type: 'GET',
                success: function (response) {
                    if (response.status) {
                        var user = response.value;
                        $('#editUserId').val(user.userId);
                        $('#editFullName').val(user.fullName);
                        $('#editIdentificationCard').val(user.identificationCard);
                        $('#editPhoneNumber').val(user.phoneNumber);
                        $('#editEmail').val(user.email);
                        $('#editUserPassword').val('');
                        $('#editRolId').val(user.rolId);
                        $('#editJobTitleId').val(user.jobTitleId);
                        $('#editDepartmentId').val(user.departmentId);
                        $('#editIsActive').val(user.isActive);
                        $('#editUserModal').modal('show');
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }

        // Función para registrar un nuevo usuario mediante AJAX
        function registerUser(user) {
            $.ajax({
                url: '/User/Register',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(user),
                success: function (response) {
                    console.log(response); // Log the response to check for errors
                    if (response.status) {
                        // Mostrar mensaje de éxito
                        $('#successMessage').html('<div class="alert alert-success">Usuario registrado con éxito.</div>');
                        // Limpiar campos del formulario
                        $('#addUserForm')[0].reset();
                        // Actualizar la lista de usuarios después de registrar
                        loadUsers();
                        $('#addUserModal').modal('hide'); // Ocultar el modal después de registrar
                    } else {
                        alert('Error al registrar usuario: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }


        // Al hacer clic en Guardar en el modal de agregar usuario
        $('#btnSaveUser').click(function () {
            var user = {
                fullName: $('#fullName').val(),
                identificationCard: $('#identificationCard').val(),
                phoneNumber: $('#phoneNumber').val(),
                email: $('#email').val(),
                userPassword: $('#userPassword').val(),
                rolId: $('#rolId').val(),
                jobTitleId: $('#jobTitleId').val(),
                departmentId: $('#departmentId').val(),
                isActive: $('#isActive').val()
            };
            registerUser(user);
        });



        // Función para actualizar usuario
        function updateUser(user) {
            $.ajax({
                url: '/User/EditUser',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(user),
                success: function (response) {
                    if (response.status) {
                        $('#successMessage').html('<div class="alert alert-success">Usuario actualizado con éxito.</div>');
                        loadUsers();
                        $('#editUserModal').modal('hide');
                    } else {
                        alert('Error al actualizar usuario: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }

        // Al hacer clic en el botón de Guardar en el modal de Agregar Usuario
        $('#btnSaveUser').click(function () {
            var user = {
                fullName: $('#fullName').val(),
                identificationCard: $('#identificationCard').val(),
                phoneNumber: $('#phoneNumber').val(),
                email: $('#email').val(),
                userPassword: $('#userPassword').val(),
                rolId: $('#rolId').val(),
                jobTitleId: $('#jobTitleId').val(),
                departmentId: $('#departmentId').val(),
                isActive: $('#isActive').val()
            };
            addUser(user);
        });

        // Al hacer clic en el botón de editar usuario en la tabla
        $('#userList').on('click', '.btn-edit', function () {
            var userId = $(this).data('userid');
            getUserById(userId);
        });

        // Al hacer clic en el botón de Actualizar en el modal de editar usuario
        $('#btnUpdateUser').click(function () {
            var user = {
                userId: $('#editUserId').val(),
                fullName: $('#editFullName').val(),
                identificationCard: $('#editIdentificationCard').val(),
                phoneNumber: $('#editPhoneNumber').val(),
                email: $('#editEmail').val(),
                userPassword: $('#editUserPassword').val(),
                rolId: $('#editRolId').val(),
                jobTitleId: $('#editJobTitleId').val(),
                departmentId: $('#editDepartmentId').val(),
                isActive: $('#editIsActive').val()
            };
            updateUser(user);
        });
        // Función para eliminar un usuario mediante AJAX
        function deleteUser(userId) {
            $.ajax({
                url: '/User/DeleteUser?id=' + userId,
                type: 'DELETE',
                success: function (response) {
                    console.log(response); // Log the response to check for errors
                    if (response.status) {
                        // Mostrar mensaje de éxito
                        $('#successMessage').html('<div class="alert alert-success">Usuario eliminado con éxito.</div>');
                        // Actualizar la lista de usuarios después de eliminar
                        loadUsers();
                    } else {
                        alert('Error al eliminar usuario: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }


        // Al hacer clic en el botón de eliminar usuario
        $('#userList').on('click', '.btn-delete', function () {
            var userId = $(this).data('userid');
            // Confirmar antes de eliminar
            if (confirm('¿Estás seguro de que deseas eliminar este usuario?')) {
                deleteUser(userId);
            }
        });


        // Cargar usuarios al cargar la página
        $(document).ready(function () {
            loadUsers();
        });
    </script>
}